package com.locallab.model;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

import org.hibernate.annotations.CreationTimestamp;

import com.locallab.model.enums.ExperimentStatus;

import jakarta.persistence.CascadeType;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.Lob;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.OneToMany;
import jakarta.persistence.Table;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * Represents a configured experiment that links a task template to execution parameters.
 *
 * <p>An Experiment defines a test scenario with specified models, hyperparameters, and iteration
 * count. Each experiment can have multiple {@link ExperimentRun} instances representing individual
 * execution results.
 *
 * <h3>Example Usage:</h3>
 *
 * <pre>
 * Experiment experiment = Experiment.builder()
 *     .name("LLM Code Review Comparison")
 *     .taskTemplate(taskTemplate)
 *     .status(ExperimentStatus.DRAFT)
 *     .config("{\"models\": [\"qwen2.5-coder:7b\"], \"iterations\": 3}")
 *     .build();
 * </pre>
 *
 * <h3>Entity Relationships:</h3>
 *
 * <ul>
 *   <li><strong>ManyToOne to TaskTemplate:</strong> Each Experiment optionally references one
 *       TaskTemplate. The relationship is lazy-loaded.
 *   <li><strong>OneToMany to ExperimentRun:</strong> An Experiment can have many ExperimentRuns.
 *       Deleting an Experiment cascades to all associated runs.
 * </ul>
 *
 * <h3>Status Lifecycle:</h3>
 *
 * <p>Experiments progress through states: DRAFT -> RUNNING -> COMPLETED/FAILED. Updates to
 * configuration are only permitted whilst in DRAFT status.
 *
 * @see TaskTemplate
 * @see ExperimentRun
 * @see ExperimentStatus
 */
@Data
@Entity
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table(name = "experiments")
public class Experiment {

    /**
     * Unique identifier for the experiment.
     *
     * <p>Auto-generated by the database upon creation.
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * Name of the experiment.
     *
     * <p>A descriptive name to identify the experiment in listings and reports.
     *
     * <p>Example: "LLM Code Review Comparison"
     */
    @NotBlank(message = "Name is required")
    @Size(max = 200, message = "Name must not exceed 200 characters")
    @Column(nullable = false, length = 200)
    private String name;

    /**
     * The task template used for this experiment.
     *
     * <p>References the TaskTemplate that defines the prompt structure. This field is optional -
     * experiments can be created without a template for ad-hoc testing. Lazy-loaded to prevent
     * unnecessary database queries.
     */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "task_template_id")
    private TaskTemplate taskTemplate;

    /**
     * Current status of the experiment.
     *
     * <p>Tracks the experiment lifecycle state. Defaults to DRAFT on creation.
     *
     * @see ExperimentStatus
     */
    @Builder.Default
    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 20)
    private ExperimentStatus status = ExperimentStatus.DRAFT;

    /**
     * JSON configuration string containing experiment parameters.
     *
     * <p>Stores hyperparameters, model list, embedding models, iteration count, and other
     * configuration details as a JSON string. Stored as a LOB to support complex configurations.
     *
     * <p>Example: {@code {"models": ["qwen2.5-coder:7b"], "iterations": 3, "temperature": 0.7}}
     */
    @Lob
    @Column(columnDefinition = "CLOB")
    private String config;

    /**
     * Timestamp when this experiment was created.
     *
     * <p>Automatically set by Hibernate on entity creation. Cannot be updated after creation.
     */
    @CreationTimestamp
    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;

    /**
     * List of experiment runs belonging to this experiment.
     *
     * <p>Each run represents a single execution with a specific model and configuration. When an
     * Experiment is deleted, all associated ExperimentRuns are also deleted (cascade). Orphan runs
     * are automatically removed.
     *
     * <p>The relationship is mapped by the {@code experiment} field in the ExperimentRun entity.
     */
    @Builder.Default
    @OneToMany(mappedBy = "experiment", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<ExperimentRun> runs = new ArrayList<>();
}
